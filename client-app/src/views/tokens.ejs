<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1, h2, h3 { color: #333; margin-bottom: 12px; }
    h2 { font-size: 1.3em; border-bottom: 2px solid #0066cc; padding-bottom: 8px; }
    h3 { font-size: 1em; color: #555; margin-top: 16px; }
    nav { margin-bottom: 20px; }
    nav a { margin-right: 16px; color: #0066cc; text-decoration: none; }
    nav a:hover { text-decoration: underline; }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 16px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.85em;
      margin: 12px 0;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 20px;
      color: #856404;
    }
    .info {
      background: #e8f4fd;
      padding: 12px;
      border-radius: 4px;
      margin: 12px 0;
      color: #0c5460;
    }
    .claim-table { width: 100%; border-collapse: collapse; margin: 12px 0; }
    .claim-table th, .claim-table td {
      text-align: left;
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
    }
    .claim-table th { background: #f8f9fa; font-weight: 600; }
    .claim-name { font-family: monospace; color: #0066cc; }
    .btn {
      display: inline-block;
      padding: 10px 20px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: 500;
      margin-right: 10px;
      border: none;
      cursor: pointer;
    }
    .btn-primary { background: #0066cc; color: white; }
    .expiry-info { display: flex; gap: 20px; margin: 12px 0; }
    .expiry-box { background: #f8f9fa; padding: 12px; border-radius: 4px; flex: 1; }
    .expiry-label { font-size: 0.85em; color: #666; }
    .expiry-value { font-size: 1.2em; font-weight: 600; color: #333; }
    .expired { color: #cc3300; }
    .valid { color: #28a745; }
  </style>
</head>
<body>
  <nav>
    <a href="/">Home</a>
    <a href="/protected/profile">Profile</a>
    <a href="/protected/tokens">Token Inspector</a>
    <a href="/protected/api-demo">API Demo</a>
  </nav>

  <div class="card">
    <h1>Token Inspector</h1>
    <p style="color: #666;">Examine your OAuth2/OIDC tokens to understand their structure and contents.</p>
  </div>

  <div class="warning">
    <strong>Security Warning:</strong> This page displays your tokens for educational purposes only.
    In a real application, you should NEVER expose tokens to the user interface.
    Tokens are sensitive credentials that grant access to protected resources.
  </div>

  <!-- Token Expiration Status -->
  <div class="card">
    <h2>Token Status</h2>
    <% const now = Date.now(); %>
    <% const isExpired = now > tokens.expiresAt; %>
    <% const timeRemaining = Math.max(0, Math.floor((tokens.expiresAt - now) / 1000)); %>

    <div class="expiry-info">
      <div class="expiry-box">
        <div class="expiry-label">Status</div>
        <div class="expiry-value <%= isExpired ? 'expired' : 'valid' %>">
          <%= isExpired ? 'EXPIRED' : 'VALID' %>
        </div>
      </div>
      <div class="expiry-box">
        <div class="expiry-label">Time Remaining</div>
        <div class="expiry-value"><%= timeRemaining %> seconds</div>
      </div>
      <div class="expiry-box">
        <div class="expiry-label">Expires At</div>
        <div class="expiry-value" style="font-size: 0.9em;">
          <%= new Date(tokens.expiresAt).toLocaleString() %>
        </div>
      </div>
    </div>

    <form action="/protected/refresh" method="POST" style="margin-top: 16px;">
      <button type="submit" class="btn btn-primary">Refresh Tokens</button>
    </form>
  </div>

  <!-- Access Token Section -->
  <div class="card">
    <h2>Access Token</h2>

    <div class="info">
      <strong>Purpose:</strong> Used to access protected resources (APIs).
      Sent in the <code>Authorization: Bearer &lt;token&gt;</code> header.
      Short-lived for security (typically 5-15 minutes).
    </div>

    <% if (accessTokenParsed) { %>
      <h3>Header</h3>
      <pre><%= JSON.stringify(accessTokenParsed.header, null, 2) %></pre>

      <h3>Payload (Claims)</h3>
      <pre><%= JSON.stringify(accessTokenParsed.payload, null, 2) %></pre>

      <h3>Key Claims Explained</h3>
      <table class="claim-table">
        <tr>
          <th>Claim</th>
          <th>Description</th>
        </tr>
        <tr>
          <td class="claim-name">iss</td>
          <td>Issuer - The authorization server that issued this token</td>
        </tr>
        <tr>
          <td class="claim-name">sub</td>
          <td>Subject - Unique identifier for the user</td>
        </tr>
        <tr>
          <td class="claim-name">aud</td>
          <td>Audience - Intended recipient(s) of the token</td>
        </tr>
        <tr>
          <td class="claim-name">exp</td>
          <td>Expiration - Unix timestamp when token expires</td>
        </tr>
        <tr>
          <td class="claim-name">iat</td>
          <td>Issued At - Unix timestamp when token was created</td>
        </tr>
        <tr>
          <td class="claim-name">scope</td>
          <td>Scopes - Permissions granted to this token</td>
        </tr>
        <tr>
          <td class="claim-name">azp</td>
          <td>Authorized Party - Client that requested this token</td>
        </tr>
      </table>
    <% } else { %>
      <p>Could not parse access token (may be opaque)</p>
    <% } %>
  </div>

  <!-- ID Token Section -->
  <div class="card">
    <h2>ID Token (OIDC)</h2>

    <div class="info">
      <strong>Purpose:</strong> Proves the user's identity. Contains claims about the user.
      Used by the client application only - should NOT be sent to APIs.
      Must be validated before trusting the claims.
    </div>

    <% if (idTokenParsed) { %>
      <h3>Header</h3>
      <pre><%= JSON.stringify(idTokenParsed.header, null, 2) %></pre>

      <h3>Payload (Claims)</h3>
      <pre><%= JSON.stringify(idTokenParsed.payload, null, 2) %></pre>

      <h3>OIDC-Specific Claims</h3>
      <table class="claim-table">
        <tr>
          <th>Claim</th>
          <th>Description</th>
        </tr>
        <tr>
          <td class="claim-name">nonce</td>
          <td>Number used once - Prevents replay attacks (must match what we sent)</td>
        </tr>
        <tr>
          <td class="claim-name">auth_time</td>
          <td>Authentication time - When the user actually authenticated</td>
        </tr>
        <tr>
          <td class="claim-name">name</td>
          <td>Full name of the user (from 'profile' scope)</td>
        </tr>
        <tr>
          <td class="claim-name">preferred_username</td>
          <td>Username the user prefers (from 'profile' scope)</td>
        </tr>
        <tr>
          <td class="claim-name">email</td>
          <td>User's email address (from 'email' scope)</td>
        </tr>
        <tr>
          <td class="claim-name">email_verified</td>
          <td>Whether email has been verified (from 'email' scope)</td>
        </tr>
      </table>
    <% } else { %>
      <p>Could not parse ID token</p>
    <% } %>
  </div>

  <!-- Refresh Token Section -->
  <div class="card">
    <h2>Refresh Token</h2>

    <div class="info">
      <strong>Purpose:</strong> Used to obtain new access tokens without re-authentication.
      Long-lived (hours to days) but should be stored securely.
      Only sent to the token endpoint, never to APIs.
    </div>

    <div class="warning">
      <strong>Security Note:</strong> Refresh tokens are highly sensitive. If compromised,
      an attacker can generate new access tokens. Store them securely (server-side only)
      and never expose them to client-side JavaScript.
    </div>

    <p><em>[Refresh token hidden for security - stored server-side only]</em></p>
  </div>
</body>
</html>
